<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Músicas - Brother Who</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- CSS -->
  <link rel="stylesheet" href="../CSS/estilo.css" />
</head>
<body>
  <!-- Cabeçalho -->
  <header class="cabecalho">
    <div id="menuToggle" class="menu-mobile">☰</div>

    <div class="logo">
      <img src="../CAPAS/Logo B-who (1).png" alt="Logo Brother Who" />
      <a href="../index.html" class="nome-banda">
        <h1>Brother Who</h1>
        <p>Rock & Metal | São Paulo</p>
      </a>
    </div>

    <nav class="menu" aria-label="Navegação principal">
      <a href="agenda.html"><i class="fa-solid fa-calendar-days"></i> Agenda</a>
      <a href="musicas.html" class="ativo"><i class="fa-solid fa-music"></i> Músicas</a>
      <a href="contato.html"><i class="fa-solid fa-user-group"></i> Contato</a>
    </nav>

    <div class="botao-show">
      <a href="../pages/contratar.html"><button type="button">Contratar Show</button></a>
    </div>
  </header>

  <main>
    <!-- Header da página -->
    <section class="sobre" aria-labelledby="titulo-musicas">
      <div class="conteudo-texto page-header">
        <h1 id="titulo-musicas">Músicas</h1>
        <p>Ouça os lançamentos e as faixas já disponíveis no Spotify.</p>
      </div>
    </section>

    <!-- Próximo Lançamento -->
    <section class="section" aria-labelledby="titulo-destaque">
      <h2 id="titulo-destaque" class="section-title">Próximo Lançamento</h2>
      <div id="musica-destaque" class="musica-destaque"><!-- preenchido via JS --></div>
    </section>

    <!-- Lista de Músicas -->
    <section class="lista-musicas section" aria-labelledby="titulo-lista">
      <h2 id="titulo-lista" class="section-title">Lista de Músicas</h2>
      <div id="lista-musicas"></div>
    </section>
  </main>

  <!-- Rodapé -->
  <footer class="rodape">
    <div class="rodape-conteudo">
      <p>&copy; 2025 Brother Who. Todos os direitos reservados.</p>
      <p>São Paulo - SP | Contato: <a href="mailto:bandabrotherwho@gmail.com">bandabrotherwho@gmail.com</a></p>
    </div>
  </footer>

  <!-- JS: menu mobile -->
  <script>
    (function () {
      const toggle = document.getElementById('menuToggle');
      const menu = document.querySelector('.menu');
      if (!toggle || !menu) return;

      const closeMenu = () => menu.classList.remove('ativo');

      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.toggle('ativo');
      });

      document.addEventListener('click', (e) => {
        if (!menu.contains(e.target) && e.target !== toggle) closeMenu();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeMenu();
      });
    })();
  </script>

  <!-- JS: planilha + destaque com contagem regressiva -->
  <script>
    const SHEET_URL = "https://opensheet.elk.sh/1SeaT_oYgJwLiR7Q-zQuBcJ75Q5QtZhhMgf37qwIbmrk/Página2";

    const norm = (v) => (v || "").toString().trim();
    const cover = (m) => norm(m["Local Foto Capa"] || m["Foto Capa"] || m["Capa"] || m["Imagem"]);

    // dd/mm/aaaa (ou aaaa-mm-dd) + HH:MM -> Date local
    function parseBRDateTime(dateStr, timeStr) {
      const dStr = norm(dateStr);
      const tStr = norm(timeStr || "00:00");
      let H = 0, Min = 0;
      const tMatch = tStr.match(/^(\d{1,2}):(\d{2})/);
      if (tMatch) { H = parseInt(tMatch[1],10); Min = parseInt(tMatch[2],10); }

      if (/^\d{2}\/\d{2}\/\d{4}$/.test(dStr)) {
        const [dd, mm, yyyy] = dStr.split("/");
        return new Date(parseInt(yyyy,10), parseInt(mm,10)-1, parseInt(dd,10), H, Min, 0, 0);
      }
      if (/^\d{4}-\d{2}-\d{2}$/.test(dStr)) {
        const [yyyy, mm, dd] = dStr.split("-");
        return new Date(parseInt(yyyy,10), parseInt(mm,10)-1, parseInt(dd,10), H, Min, 0, 0);
      }
      const tryParse = new Date(`${dStr} ${tStr}`);
      return isNaN(tryParse) ? null : tryParse;
    }

    function formatDiff(ms) {
      if (ms <= 0) return { d:0, h:0, m:0, s:0 };
      const total = Math.floor(ms/1000);
      const d = Math.floor(total / (3600*24));
      const h = Math.floor((total % (3600*24)) / 3600);
      const m = Math.floor((total % 3600) / 60);
      const s = total % 60;
      return { d, h, m, s };
    }

    function renderLista(musicas, listaEl) {
      listaEl.innerHTML = "";
      const albuns = {};
      musicas.forEach(m => {
        const album = norm(m["Album"]) || "Sem Álbum";
        (albuns[album] ||= []).push(m);
      });

      Object.keys(albuns).forEach(nomeAlbum => {
        const bloco = document.createElement("div");
        bloco.className = "bloco-album";

        const titulo = document.createElement("h3");
        titulo.className = "titulo-album";
        titulo.textContent = `Álbum: ${nomeAlbum}`;
        bloco.appendChild(titulo);

        albuns[nomeAlbum].forEach(m => {
          const capa = cover(m);
          const nome = norm(m["Nome da Musica"]);
          const link = norm(m["Link do Spotify"]);

          const item = document.createElement("div");
          item.className = "musica-item";
          item.innerHTML = `
            <img src="${capa}" alt="Capa da música ${nome}" loading="lazy" />
            <div class="musica-info">
              <strong>${nome}</strong>
            </div>
            ${link ? `
              <a href="${link}" target="_blank" class="botao-play" aria-label="Ouvir ${nome} no Spotify" rel="noopener">
                <i class="fab fa-spotify"></i>
              </a>` : ``}
          `;
          bloco.appendChild(item);
        });

        listaEl.appendChild(bloco);
      });
    }

    function renderDestaque(m, container, onExpire) {
      const capa = cover(m);
      const nome = norm(m["Nome da Musica"]);
      const album = norm(m["Album"]);
      const dataLanc = norm(m["Data do Lançamento"]);
      const horaLanc = norm(m["Hora do Lançamento"]);
      const alvo = parseBRDateTime(dataLanc, horaLanc);
      const futuro = alvo && (alvo.getTime() > Date.now());

      container.innerHTML = `
        ${futuro ? `<div class="badge">Em breve</div>` : ``}
        <div class="cover"><img src="${capa}" alt="Capa da música ${nome}" /></div>
        <h3>${nome}</h3>
        ${album ? `<p class="meta"><em>Álbum: ${album}</em></p>` : ``}
        ${dataLanc ? `<p class="meta"><strong>Lançamento:</strong> ${dataLanc}${horaLanc ? " às " + horaLanc : ""}</p>` : ``}
        ${futuro ? `
          <div class="countdown" role="timer" aria-live="polite">
            <div class="countdown-grid">
              <div class="box"><div class="num" id="cd-d">0</div><div class="label">dias</div></div>
              <div class="box"><div class="num" id="cd-h">0</div><div class="label">horas</div></div>
              <div class="box"><div class="num" id="cd-m">0</div><div class="label">min</div></div>
              <div class="box"><div class="num" id="cd-s">0</div><div class="label">seg</div></div>
            </div>
            <div class="countdown-status" id="cd-status" style="margin-top:8px;"></div>
          </div>
        ` : `<p class="countdown-live">Disponível agora!</p>`}
      `;

      if (!futuro) return;

      const elD = container.querySelector("#cd-d");
      const elH = container.querySelector("#cd-h");
      const elM = container.querySelector("#cd-m");
      const elS = container.querySelector("#cd-s");
      const elStatus = container.querySelector("#cd-status");

      const tick = () => {
        const diff = alvo.getTime() - Date.now();
        if (diff <= 0) {
          clearInterval(timer);
          elD.textContent = elH.textContent = elM.textContent = elS.textContent = "0";
          elStatus.textContent = "Lançada!";
          if (typeof onExpire === "function") onExpire();
          return;
        }
        const { d, h, m, s } = formatDiff(diff);
        elD.textContent = d;
        elH.textContent = h.toString().padStart(2, "0");
        elM.textContent = m.toString().padStart(2, "0");
        elS.textContent = s.toString().padStart(2, "0");
        elStatus.textContent = "";
      };

      tick();
      const timer = setInterval(tick, 1000);
    }

    fetch(SHEET_URL)
      .then(res => res.json())
      .then(data => {
        const destaqueEl = document.getElementById("musica-destaque");
        const listaEl = document.getElementById("lista-musicas");

        const status = (m) => norm(m["Status"]).toLowerCase();
        const isLancada = (m) => status(m) === "lançada";
        const isProx = (m) => status(m) === "próximo lançamento";

        let lancadas = data.filter(isLancada);
        const proximos = data.filter(isProx);

        renderLista(lancadas, listaEl);

        if (proximos.length) {
          const withDate = proximos
            .map(m => ({ m, date: parseBRDateTime(m["Data do Lançamento"], m["Hora do Lançamento"]) }))
            .filter(x => x.date);
          const proximo = withDate.length
            ? withDate.sort((a,b) => a.date - b.date)[0].m
            : proximos[0];

          const onExpire = () => {
            proximo["Status"] = "lançada";
            lancadas.push(proximo);
            renderLista(lancadas, listaEl);
            destaqueEl.innerHTML = `<p class="countdown-live">Disponível agora!</p>`;
          };

          renderDestaque(proximo, destaqueEl, onExpire);
        } else {
          destaqueEl.innerHTML = "<p>Nenhum próximo lançamento encontrado.</p>";
        }
      })
      .catch(err => {
        console.error("Erro ao carregar músicas:", err);
        document.getElementById("musica-destaque").innerHTML = "<p>Erro ao carregar músicas. Tente mais tarde.</p>";
      });
  </script>
</body>
</html>
